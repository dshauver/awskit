---
devhops::create_master::instance_type: 't2.large'
devhops::create_agents::instance_type_lin: 't2.micro'
devhops::create_agents::instance_type_win: 't2.small'
devhops::create_discovery::instance_type: 't2.small'
devhops::create_windc::instance_type: 't2.small'
devhops::join_domain_password: 'PuppetD3vh0ps!'

devhops::vpc: 'default'
devhops::tags:
  description: 'DevHops Infrastructure'
  created_by: 'dimitri.tischenko@puppetlabs.com'
  department: 'TSE'
  project: 'DevHops workshops'

devhops::create_agents::centos_user_data: |
  #! /bin/bash
  echo "<%= $devhops::master_ip %> master.inf.puppet.vm master" >> /etc/hosts
  #hostname=$(curl http://169.254.169.254/latest/meta-data/public-hostname)
  curl -k https://master.inf.puppet.vm:8140/packages/current/install.bash | bash -s agent:certname="linhops-<%= $i %>"

devhops::create_agents::windows_user_data: |
  <powershell>
  $hosts = "$env:windir\System32\drivers\etc\hosts"
  "<%= $devhops::master_ip %> master.inf.puppet.vm master" | Add-Content -PassThru $hosts
  [Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}; 
  $webClient = New-Object System.Net.WebClient; 
  $webClient.DownloadFile('https://master:8140/packages/current/install.ps1', 'install.ps1'); 
  .\install.ps1 main:certname="winhops-<%= $i %>"
  winrm quickconfig -force
  </powershell>

devhops::create_agents::centos_count: 2
devhops::create_agents::windows_count: 2

devhops::create_discovery::centos_user_data: |
  #! /bin/bash
  #hostname=$(curl http://169.254.169.254/latest/meta-data/public-hostname)
  yum install -y yum-utils device-mapper-persistent-data lvm2
  yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  yum install -y docker-ce
  systemctl enable docker
  systemctl start docker
  curl -o ~/puppet-discovery https://storage.googleapis.com/chvwcgv0lwrpc2nvdmvyes1jbgkk/108a15a/linux-amd64/puppet-discovery
  chmod a+x ~/puppet-discovery
  ~/puppet-discovery init --with-dev-password puppet

devhops::create_windc::windows_user_data: |
  <powershell>
  $hosts = "$env:windir\System32\drivers\etc\hosts"
  "<%= $devhops::master_ip %> master.inf.puppet.vm master" | Add-Content -PassThru $hosts
  [Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}; 
  $webClient = New-Object System.Net.WebClient; 
  $webClient.DownloadFile('https://master:8140/packages/current/install.ps1', 'install.ps1'); 
  .\install.ps1 main:certname="windchops-1.inf.puppet.vm"
  winrm quickconfig -force
  </powershell>

devhops::amis:
  us-west-2: # US/Canada
    pm: ami-6209801a
  eu-west-2: # London
    pm:       ami-9604e0f1 # 2017.3.5
    centos:   ami-ee6a718a # centos 7
    windows:  ami-9f677cfb # windows 2012
  eu-west-3: # Paris
    pm: ami-de73c5a3
  eu-central-1: # (Frankfurt):
    pm: ami-86761be9
  ap-southeast-2: # (Sydney)
    pm: ami-a6995fc4
  ap-southeast-1: # (Singapore)
    pm: ami-3b93db47
