---
lookup_options:
  devhops::tags:
    merge: deep

devhops::create_master::instance_type: 't2.large'
devhops::create_agents::instance_type_lin: 't2.micro'
devhops::create_agents::instance_type_win: 't2.small'
devhops::create_discovery::instance_type: 't2.small'
devhops::create_windc::instance_type: 't2.small'
devhops::windows_domain::dn: DC=devhops,DC=local
devhops::windows_domain::localadminpw: 'PuppetD3vh0ps!'
devhops::windows_domain::name: devhops.local
devhops::windows_domain::ntdspath: C:\\NTDS
devhops::windows_domain::safemodepw: 'PuppetD3vh0ps!'
devhops::windows_domain::join_user: 'Administrator'
devhops::windows_domain::join_password: 'PuppetD3vh0ps!'

devhops::tags:
  description: 'DevHops Infrastructure'
  department: 'TSE'
  project: 'DevHops workshops'
  lifetime: 10w
  Schedule: '-21:00'
  
devhops::vpc: 'default'

devhops::create_agents::centos_user_data: |
  #! /bin/bash
  echo "<%= $devhops::master_ip %> master.inf.puppet.vm master" >> /etc/hosts
  #hostname=$(curl http://169.254.169.254/latest/meta-data/public-hostname)
  curl -k https://master.inf.puppet.vm:8140/packages/current/install.bash | bash -s agent:certname="linhops-<%= $i %>"

devhops::create_agents::windows_user_data: |
  <powershell>
  $hosts = "$env:windir\System32\drivers\etc\hosts"
  "<%= $devhops::master_ip %> master.inf.puppet.vm master" | Add-Content -PassThru $hosts
  [Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}; 
  $webClient = New-Object System.Net.WebClient; 
  $webClient.DownloadFile('https://master:8140/packages/current/install.ps1', 'install.ps1'); 
  .\install.ps1 main:certname="winhops-<%= $i %>"
  winrm quickconfig -force
  </powershell>

devhops::create_agents::centos_count: 2
devhops::create_agents::windows_count: 2

devhops::create_discovery::centos_user_data: |
  #! /bin/bash
  #hostname=$(curl http://169.254.169.254/latest/meta-data/public-hostname)
  yum install -y yum-utils device-mapper-persistent-data lvm2
  yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  yum install -y docker-ce
  systemctl enable docker
  systemctl start docker
  curl -o ~/puppet-discovery https://storage.googleapis.com/chvwcgv0lwrpc2nvdmvyes1jbgkk/108a15a/linux-amd64/puppet-discovery
  chmod a+x ~/puppet-discovery
  ~/puppet-discovery init --with-dev-password puppet

devhops::create_master::user_data: |
  #! /bin/bash
  sleep 120 # give time for startup
  cd /tmp
  git clone <%= $control_repo %> control-repo
  cd control-repo
  git remote add gogs git@localhost:puppet/control-repo.git
  git push gogs production
  <% $gogs_ssh_keys.each |$title| { -%>
  curl -u puppet:puppetlabs -X POST -H "Content-Type: application/json" -d \
  '{"title": "<%= $title %>", "key": "<%= $gogs_ssh_keys[$title] %>"}'
  <% } -%>

devhops::create_master::control_repo: https://github.com/timidri/control-repo
  
devhops::create_windc::windows_user_data: |
  <powershell>
  $hosts = "$env:windir\System32\drivers\etc\hosts"
  "<%= $devhops::master_ip %> master.inf.puppet.vm master" | Add-Content -PassThru $hosts
  [Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}; 
  $webClient = New-Object System.Net.WebClient; 
  $webClient.DownloadFile('https://master:8140/packages/current/install.ps1', 'install.ps1'); 
  .\install.ps1 main:certname="windchops-1.inf.puppet.vm"
  winrm quickconfig -force
  </powershell>

devhops::amis:
  us-west-2: # US/Canada
    pm: ami-6209801a
  eu-west-2: # London
    pm:        ami-9604e0f1 # tse-master-vmware-2017.3.5-v0.0.8.ova
    centos:    ami-ee6a718a # CentOS Linux 7 x86_64 HVM EBS
    windows:   ami-9f677cfb # Windows_Server-2012-R2_RTM-English-64Bit-Base-2018.01.12
    discovery: ami-ee6a718a # CentOS Linux 7 x86_64 HVM EBS
    windc:     ami-8bee09ec # Windows_Server-2016-English-Full-Base-2018.03.06
  eu-west-3: # Paris
    pm: ami-de73c5a3
  eu-central-1: # (Frankfurt):
    pm: ami-86761be9
  ap-southeast-2: # (Sydney)
    pm: ami-a6995fc4
  ap-southeast-1: # (Singapore)
    pm: ami-3b93db47
